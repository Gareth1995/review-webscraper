CREATE EXTENSION IF NOT EXISTS "pgcrypto"; -- Enables UUID generation

CREATE TABLE hotels (
    hotel_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    location VARCHAR(255),
    url TEXT UNIQUE 
);

CREATE TABLE sources (
    source_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    source_name VARCHAR(100) UNIQUE NOT NULL
);

CREATE TABLE reviews (
    review_id BIGSERIAL PRIMARY KEY,
    hotel_id UUID REFERENCES hotels(hotel_id) ON DELETE CASCADE,
    source_id UUID REFERENCES sources(source_id) ON DELETE CASCADE,
    review_text TEXT,
    review_rating DECIMAL(3,2),
    reviewer_name VARCHAR(255),
    review_date VARCHAR(255),
    sentiment VARCHAR(50),
    country VARCHAR(100),
    UNIQUE (hotel_id, source_id, reviewer_name, review_text) 
);

CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,
    user_name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,  -- Ensures unique emails
    hotel_id UUID REFERENCES hotels(hotel_id) ON DELETE CASCADE
);

INSERT INTO users (user_name, email, hotel_id)
VALUES ('John Doe', 'johndoe@example.com', 'e1ada55f-000c-4991-9527-f72362cb6e80');


INSERT INTO hotels (name, location, url)
VALUES 
    ('The Bantry Aparthotel by Totalstay', 'Cape Town, South Africa', 'https://www.booking.com/hotel/za/bantry-bay-suite-hotel-cape-town.html?aid=304142&label=gen173nr-1FCAEoggI46AdIM1gEaPsBiAEBmAExuAEXyAEM2AEB6AEB-AECiAIBqAIDuAK3xLi9BsACAdICJDRkNWQzMjllLTNmZDMtNDM0OC1hYmU4LTFhY2VlNzhiYjIyNtgCBeACAQ&sid=989dc5e594027c7ff3b4d7505cacb436&checkin=2025-03-01&checkout=2025-03-15&dest_id=15149&dest_type=hotel&dist=0&group_adults=2&group_children=0&hapos=1&hpos=1&no_rooms=1&req_adults=2&req_children=0&room1=A%2CA&sb_price_type=total&soh=1&sr_order=popularity&srepoch=1739465289&srpvid=947b76239fff0960&type=total&ucfs=1&#no_availability_msg')

INSERT INTO sources (source_name)
VALUES
	('booking.com');

-- For viewing the reviews table
SET client_encoding TO 'UTF8'; -- call first before select * from reviews

ALTER TABLE reviews 
ALTER COLUMN review_text DROP NOT NULL;

SELECT COUNT(*) FROM reviews;


SELECT hotel_id, AVG(review_rating) AS average_rating
FROM reviews
WHERE hotel_id = 'e1ada55f-000c-4991-9527-f72362cb6e80'
GROUP BY hotel_id;


SELECT sentiment, COUNT(sentiment) as count
FROM reviews
WHERE hotel_id = 'e1ada55f-000c-4991-9527-f72362cb6e80'
GROUP BY sentiment
ORDER BY count DESC
LIMIT 1
